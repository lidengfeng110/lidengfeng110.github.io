<!DOCTYPE html><html lang="null"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>实验： 实现mysql 数据库的主从复制高可用，用MHA实现 | Hexo</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">实验： 实现mysql 数据库的主从复制高可用，用MHA实现</h1><a id="logo" href="/.">Hexo</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">实验： 实现mysql 数据库的主从复制高可用，用MHA实现</h1><div class="post-meta"><a href="/2017/06/12/实验： 实现mysql 数据库的主从复制高可用，用MHA实现/#comments" class="comment-count"></a><p><span class="date">Jun 12, 2017</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Schlägt</i></i></span></p></div><div class="post-content"><h2 id="实验：-实现mysql-数据库的主从复制高可用，用MHA实现"><a href="#实验：-实现mysql-数据库的主从复制高可用，用MHA实现" class="headerlink" title="实验： 实现mysql 数据库的主从复制高可用，用MHA实现"></a>实验： 实现mysql 数据库的主从复制高可用，用MHA实现</h2><pre><code>做这个实验我们准备了四台主机，分别为： 192.168.30.7  ,  192.168.30.17  ,  192.168.30.27  ,  192.168.30.37  
      用 192.168.30.7 这台主机来做  Manager ,用来监控管理，他负责监控集群中的主节点状态，一旦发现主节点出问题了，它会提升一个从节点来当新的主节点。  

        用 192.168.30.17 这台主机来做 master （主服务器）  
        用  192.168.30.27   192.168.30.37    这两台主机来做 slave （从服务器）  
</code></pre><p>   注意： 做集群对时间要求特别严格，一定要保证集群中的主机时间都同步。<br>             一般在生产中用 ntp 服务把集群中的所有主机都同步到一台主机上。 如： ntpdate  172.20.0.1<br> 这样的操作在每个主机上都执行一遍。记得先要启动这个服务  systemctl start ntpd   systemctl enable ntpd<br>   并在配置文件中添加    vim /etc/ntp.conf<br>   server 172.20.0.1 iburst<br>   然后重启服务     systemctl restart ntpd  </p>
<a id="more"></a>
<p>   再查看下防火墙和 seliunx 都设置好了没。  </p>
<p>  接下里就开始配置<br>首先在主服务器 master （192.168.30.17）上安装数据库<br> yum install mariadb-server<br> 安装好以后启动服务       systemctl start mariadb  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">修改配置文件   vim /etc/my.cnf</span><br><span class="line">  在里面添加      server_id=1</span><br><span class="line">                          log_bin</span><br><span class="line">                           binlog_format=row</span><br><span class="line">                            skip_name_resolve</span><br></pre></td></tr></table></figure>
<p>   接下来在数据库中创建账号    ：<br>grant replication slave on <em>.</em> to repluser@’192.168.30.%’ identified by ‘centos’;  </p>
<p>接下来在从服务器 slave （192.168.30.27）上安装数据库<br> yum install mariadb-server  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">修改配置文件       vim /etc/my.cnf</span><br><span class="line"> 在里面添加内容          server_id=2</span><br><span class="line">                                    log_bin</span><br><span class="line">                                    read_only=1</span><br><span class="line">                                     relay_log_purge=0</span><br><span class="line">                                     skip_name_resolve=1</span><br></pre></td></tr></table></figure>
<p>修改完启动服务      systemctl start mariadb  </p>
<p>接下里在数据库中执行命令：<br>                    C<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HANGE MASTER TO   MASTER_HOST=&apos;192.168.30.17&apos;,   MASTER_USER=&apos;repluser&apos;,   MASTER_PASSWORD=&apos;centos&apos;,   MASTER_PORT=3306,   MASTER_LOG_FILE=&apos;master-bin.000001&apos;,   MASTER_LOG_POS=245;</span><br></pre></td></tr></table></figure></p>
<p>然后进行同步： start slave;  </p>
<p>接下来在从服务器 slave （192.168.30.37）上安装数据库<br>  yum install mariadb-server  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">修改配置文件       vim /etc/my.cnf</span><br><span class="line"> 在里面添加内容          server_id=3</span><br><span class="line">                                    log_bin</span><br><span class="line">                                    read_only=1</span><br><span class="line">                                     relay_log_purge=0</span><br><span class="line">                                     skip_name_resolve=1</span><br></pre></td></tr></table></figure>
<p>修改完启动服务      systemctl start mariadb  </p>
<p>接下里在数据库中执行命令：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO   MASTER_HOST=&apos;192.168.30.17&apos;,   MASTER_USER=&apos;repluser&apos;,   MASTER_PASSWORD=&apos;centos&apos;,   MASTER_PORT=3306,   MASTER_LOG_FILE=&apos;master-bin.000001&apos;,   MASTER_LOG_POS=245;</span><br></pre></td></tr></table></figure>
<p>然后进行同步 ：  start slave;  </p>
<p>现在来到 manager （192.168.30.7）这台主机上，这台主机将来要监控管理的，以前主从架构发生损坏后都是人工去改动，现在用了 MHA 就可以实现自动化改动，而MHA 是需要安装两个包的。<br> 还有一点需用考虑，就是 Manager 将来要连接到主服务器上的抓取日志需要相应的权限，所以要创建专门的用户来实现这个功能。还有考虑到访问文件的安全性还要基于 SSH key 的验证，使主机之间可以互相访问。  </p>
<pre><code>    现在在 manager 主机上实现 SSH 验证          ssh-keygen  

     然后     ssh-copy-id 192.168.30.7         生成秘钥对     
       在 .ssh/authorized_keys      就会生成相应的公钥

 然后把 公钥复制到相应的主机上去 ：  
    scp -pr .ssh 192.168.30.17:/root/  
     scp -pr .ssh 192.168.30.27:/root/  
     scp -pr .ssh 192.168.30.37:/root/  
现在就实现了基于 key 验证了  
</code></pre><p>现在需要在所有主机上建立一个专门的数据库管理账号，将来让 manager 利用这些账号来管理各个服务器上的数据。  </p>
<pre><code>现在在主服务器的数据库上创建账号 ：  
 grant all on *.* to mhauser@&apos;192.168.30.%&apos; identified by &apos;centos&apos;;  
</code></pre><p>因为这个账号是同步以后创建的，所以主服务器上一创建，就会复制到从服务器上。   </p>
<p>到此前期的准备工作就做完了，接下来正式进行 MHA 工作。  </p>
<p>现在需要在所有主机上安装 MHA 相关的软件包   (依赖epel源)<br>在 manager 主机上安装：<br>        yum     install      mha4mysql-manager-0.56-0.e16.noarch.rpm<br>         yum install      mha4mysql-node-0.56-0.e16.noarch.rpm  </p>
<p>在 master 主机上安装 ：<br>             yum install      mha4mysql-node-0.56-0.e16.noarch.rpm<br>在slave1 主机上安装 ：<br>                yum install      mha4mysql-node-0.56-0.e16.noarch.rpm<br>在slave2 主机上安装 ：<br>                yum install      mha4mysql-node-0.56-0.e16.noarch.rpm<br>这样各自的包就安装完成了。  </p>
<p>现在在 manager 主机上创建配置文件 ,先创建一个目录<br>     mkdir /etc/mha/         vim /etc/mha/app1.conf  </p>
<pre><code>     [server default]
  user=mhauser
password=centos 
manager_workdir=/data/mastermha/app1/ 
manager_log=/data/mastermha/app1/manager.log 
 remote_workdir=/data/mastermha/app1/
ssh_user=root 
  repl_user=repluser
 repl_password=centos
    ping_interval=1

    [server1]
    hostname=192.168.30.17
    candidate_master=1
   [server2]
    hostname=192.168.30.27 
   candidate_master=1
   [server3] 
    hostname=192.168.30.37
</code></pre><p>接下来命令来检测一下当前的环境是否已经准备好了。<br> masterha_check_ssh –conf=/etc/mha/app1.conf<br>这表示检测 SSH 是否连接成功<br> masterha_check_repl –conf=/etc/mha/app1.conf  </p>
<h1 id="这表示是否能够正常复制"><a href="#这表示是否能够正常复制" class="headerlink" title="这表示是否能够正常复制"></a>这表示是否能够正常复制</h1><p>masterha_master –conf=/etc/mha/app1.conf<br> 这就表示开启集群，这个变量是前台执行的，所以在生产中一定要在本机上执行这个操作，不要在远程终端上连接。这个变量开启后，一直保持前台执行状态，只有等他监控的主机发生改变就会停下来。  </p>
<pre><code> 到此就实现了 MHA 的高可用性。  
接下来可以做做修改，模拟下破坏来测试下。  
</code></pre><p>  现在是一台主服务器，两个从服务器，实现 MHA 以后，一旦主服务器突然宕机，MHA 会自动的切换一个有资格的做主服务器的从服务器，让他来接管主服务器的工作。一旦切换， manager 主机也会停止前台工作。但是现在问题来了，主服务器是切换了，调度器却把增删改相应的用户还指向原来的主服务器上，所以切换后，还要把调度器的指向也修改过来。  </p>
</div><div class="tags"><a href="/tags/Linux/">Linux</a><a href="/tags/mysql/">mysql</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2017/06/13/mysql 数据库的各种规范/" class="pre">mysql 数据库的各种规范</a><a href="/2017/06/11/LAMP 架构的各种演示/" class="next">LAMP 架构的各种演示</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Inhalte</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#实验：-实现mysql-数据库的主从复制高可用，用MHA实现"><span class="toc-text">实验： 实现mysql 数据库的主从复制高可用，用MHA实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#这表示是否能够正常复制"><span class="toc-text">这表示是否能够正常复制</span></a></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/08/09/keepalived高可用/">Ansible</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/09/Nginx 各种实验演示/">Nginx 各种实验演示</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/09/Nginx 详细介绍/">Nginx 详细介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/09/日志管理介绍/">日志管理介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/09/Linux 防火墙各种规则实战应用/">Linux 防火墙各种规则实战应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/15/memcache  缓存原理介绍/">memcache  缓存原理介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/08/tomcat 各种架构实验演示/">tomcat 各种架构实验演示</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/05/浅谈 tomcat 原理/">浅谈 tomcat 原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/25/Varnish 缓存服务器介绍/">Varnish 缓存服务器介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/14/keepalived 各种高可用实战演练/">keepalived 各种高可用实战演练</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"><a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/DNS/" style="font-size: 15px;">DNS</a> <a href="/tags/haproxy/" style="font-size: 15px;">haproxy</a> <a href="/tags/用户组/" style="font-size: 15px;">用户组</a> <a href="/tags/LAMP/" style="font-size: 15px;">LAMP</a> <a href="/tags/权限管理/" style="font-size: 15px;">权限管理</a> <a href="/tags/练习题/" style="font-size: 15px;">练习题</a> <a href="/tags/su和sudo/" style="font-size: 15px;">su和sudo</a> <a href="/tags/MYSQL/" style="font-size: 15px;">MYSQL</a> <a href="/tags/文件系统/" style="font-size: 15px;">文件系统</a> <a href="/tags/SSH/" style="font-size: 15px;">SSH</a> <a href="/tags/TCP-IP/" style="font-size: 15px;">TCP/IP</a> <a href="/tags/varnish/" style="font-size: 15px;">varnish</a> <a href="/tags/DHCP/" style="font-size: 15px;">DHCP</a> <a href="/tags/keepalied/" style="font-size: 15px;">keepalied</a> <a href="/tags/自动化/" style="font-size: 15px;">自动化</a> <a href="/tags/memcache/" style="font-size: 15px;">memcache</a> <a href="/tags/lvs/" style="font-size: 15px;">lvs</a> <a href="/tags/tomcat/" style="font-size: 15px;">tomcat</a> <a href="/tags/共享服务/" style="font-size: 15px;">共享服务</a> <a href="/tags/rpm/" style="font-size: 15px;">rpm</a> <a href="/tags/自动化安装/" style="font-size: 15px;">自动化安装</a> <a href="/tags/基本命令/" style="font-size: 15px;">基本命令</a> <a href="/tags/CA/" style="font-size: 15px;">CA</a> <a href="/tags/dns/" style="font-size: 15px;">dns</a> <a href="/tags/sed/" style="font-size: 15px;">sed</a> <a href="/tags/mini系统/" style="font-size: 15px;">mini系统</a> <a href="/tags/进程管理、计划任务/" style="font-size: 15px;">进程管理、计划任务</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archiv</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">RSS</a> |  <a href="/about/">Über</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">John Doe.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>